{% extends "layout.njk" %}
{% block body %}
  <h1>
    <i class="fas fa-sign-in-alt"></i>
    Log in
  </h1>
  <form id="form">
    <fieldset>
      <label for="email">Email</label>
      <input type="email" name="email" id="email" placeholder="Email" autofocus="autofocus" required="required">

      <label for="password">Password</label>
      <input type="password" name="password" id="password" placeholder="Password" autofocus="autofocus" required="required">
    </fieldset>
    <div id="errors"></div>
    <button type="submit">
      <i class="fas fa-sign-in-alt"></i>
      Log in
    </button>
  </form>
  <p>
    Don't have an account?
    <a href="/auth/register">Sign up</a>
  </p>
  <p>
    Forgot your password?
    <a href="/auth/reset-password-request">Reset your password</a>
  </p>
{% endblock %}

{% block javascript %}
  <script>
    const form = document.getElementById("form");
    const errors = document.getElementById("errors");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Remove aria-invalid from all fields
      document
        .querySelectorAll('[aria-invalid]')
        .forEach((elem) => {
          elem.setAttribute('aria-invalid', 'false');
        });

      errors.innerHTML = "";

      // Get the form data
      const email = document.getElementById("email");
      const password = document.getElementById("password");

      const body = JSON.stringify({
        email: email.value
          ? email.value
          : undefined,
        password: password.value
          ? password.value
          : undefined
      });

      const response = await fetch("/api/auth/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body
      });

      if (response.ok) {
        window.location = "/";
      } else {
        await manageErrors(response, errors);
      }
    });
  </script>
{% endblock %}
