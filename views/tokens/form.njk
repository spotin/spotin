{% extends "layout.njk" %}

{% block body %}
<h2><i class="fas fa-key"></i> New token</h2>
<form action="/api/tokens" method="POST">
    <fieldset>
        <label for="name">Name</label> 
        {% if errors.name %}
        <span class="error">The name field cannot be empty</span>
        <input name="name" id="name" placeholder="Name" value="{{ values.name }}" aria-invalid="true" autofocus>
        {% else %}
        <input name="name" id="name" placeholder="Name" value="{{ values.name }}" autofocus>
        {% endif %}
    </fieldset>
    <button type="submit"><i class="fas fa-save"></i> New token</button>
</form>
<script>
    const form = document.querySelector('form');

    async function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const name = formData.get('name');

        const body = { name };
        try {
            const res = await fetch('/api/tokens', {
                method: 'POST',
                body: JSON.stringify(body),
                headers: {
                    'content-type': 'application/json'
                }
            });

            const TokenDTO = await res.json();

            if(res.status === 201) {
                window.location.href = `/tokens/view/${TokenDTO.hash}/${TokenDTO.name}`;
            }

        } catch (err) {
            console.error(err);
        }
    }

    form.addEventListener('submit', handleSubmit);
</script>
{% endblock %}
