{% extends "layout.njk" %}

{% block body %}
<h2><i class="fas fa-map-marker-alt"></i> {{ title }}</h2>
{% if spot.id %}
<form id="spot-form" action="/spots/{{ spot.id }}" method="POST">
{% else %}
<form id="spot-form" action="/spots" method="POST">
{% endif %}
    <label for="title">
        Title
        {% if errors.title %}
        <span class="error">(cannot be empty)</span>
        <input name="title" id="title" placeholder="Title" value="{{ spot.title }}" aria-invalid="true" autofocus>
        {% else %}
        <input name="title" id="title" placeholder="Title" value="{{ spot.title }}" autofocus>
        {% endif %}
    </label>

    <label for="description">
        Description
        <textarea id="description" type="text" name="description" placeholder="Description">{{ spot.description }}</textarea>
    </label>

    <!-- Prompt user for current location -->
    <button type="button" onclick="navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
    });">
        <i class="fas fa-map-marker-alt"></i> Use current location
    </button>

    <div class="grid">
        <label for="latitude">
            Latitude (between -90.0 and 90.0)
            {% if errors.coordinates %}
            <span class="error">(between -90.0 and 90.0)</span>
            <input id="latitude" type="number" step="0.00001" name="latitude" lang="en" placeholder="46.818188"
                value="{{ spot.latitude }}" aria-invalid="true" min="-90" max="90">
            {% else %}
                <input id="latitude" type="number" step="0.00001" name="latitude" lang="en" placeholder="46.818188"
                value="{{ spot.latitude }}" min="-90" max="90">
            {% endif %}
        </label>
        <label for="longitude">
            Longitude (between -180.0 and 180.0)
            {% if errors.coordinates %}
            <span class="error">(between -180.0 and 180.0)</span>
            <input id="longitude" type="number" step="0.00001" name="longitude" lang="en" placeholder="8.227512"
                value="{{ spot.longitude }}" aria-invalid="true" min="-180" max="180">
            {% else %}
                <input id="longitude" type="number" step="0.00001" name="longitude" lang="en" placeholder="8.227511"
                value="{{ spot.longitude }}" min="-180" max="180">
            {% endif %}
        </label>
    </div>

    <label for="redirection">
        Redirection URL
        {% if errors.redirection %}
        <span class="error">Redirection must be a valid URL</span>
        <input id="redirection" type="text" name="redirection" placeholder="http(s)://"
        value="{{ spot.redirection }}">
        {% else %}
            <input id="redirection" type="text" name="redirection" placeholder="http(s)://"
        value="{{ spot.redirection }}">
        {% endif %}
    </label>
    <label for="referenced" {{ 'hidden' if role === "GUEST" }}>
        Referenced
        <input id="referenced" type="checkbox" name="referenced" value="true" {% if spot.referenced %}checked{% endif %}>
    </label>

    <label for="configured" {{ 'hidden' if role === "GUEST" }}>
        Configured
        <input id="configured" type="checkbox" name="configured" value="true" {% if spot.configured %}checked{% endif %}>
    </label>
    <br>

    <button type="submit"><i class="fas fa-save"></i> Save</button>
</form>
<script>
    const form = document.getElementById("spot-form");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        // Get forms fields
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const longitude = document.getElementById("longitude").value;
        const latitude = document.getElementById("latitude").value;
        const redirection = document.getElementById("redirection").value;
        {% if user.role != "GUEST" %}
        const referenced = document.getElementById("referenced").checked;
        const configured = document.getElementById("configured").checked;
        {% endif %}

        const res = await fetch(form.action, {
            method: form.method,
            redirect: 'manual',
            headers: {
                "content-type": "application/json"
            },
            body: JSON.stringify({
                title: title !== '' ? title : undefined,
                description: description !== '' ? description : undefined,
                // if the user's machine language is not english, the decimal separator is a comma
                longitude: longitude !== '' ? parseFloat(longitude.replace(',', '.')) : null,
                latitude: latitude !== '' ? parseFloat(latitude.replace(',', '.')) : null,
                redirection: redirection !== '' ? redirection : undefined,
                referenced: referenced,
                configured: configured,
            }),
        });

        // Redirect the user
        window.location = res.url;
    });
</script>
{% endblock %}
